# -*- mode: sh; sh-basic-offset: 3; indent-tabs-mode: nil; -*-
# vim: set filetype=sh sw=3 sts=3 expandtab autoindent:
#
# bup handler script for backupninja
# requires the bup binary, and ssh for remote connections
#

### GET CONFIG ###

setsection source
getconf bupdir
getconf path

setsection dest
getconf branch

getconf type local
# Those two values are only useful if type is set to "remote"
getconf host localhost
getconf user
getconf remote_dir

REMOTE_URL=
if [ "$type" = "remote" ]; then
    REMOTE_URL="$host"

    if [ -n "$user" ]; then
        REMOTE_URL="${user}@$REMOTE_URL"
    fi

    REMOTE_URL="-r $REMOTE_URL:$remote_dir"
    debug "remote location arguments: '$REMOTE_URL'"
fi

REPOSITORY=
if [ -n "$bupdir" ]; then
    REPOSITORY="-d $bupdir"
    debug "bup repository arguments: '$REPOSITORY'"
fi

### CHECK CONFIG ###
if [ -z "$path" ]; then
    fatal "No source path was given."
fi

if [ -z "$branch" ]; then
    fatal "The backup branch was not specified."
fi

if [ -z "$bupdir" ]; then
    debug "No bupdir specified: using the default location of ~/.bup !"
fi

### REMOVE OLD BACKUPS ###
# This is not yet implemented in bup itself.

### EXECUTE ###

for s_path in $path; do
    bup $REPOSITORY index $s_path
done

for s_path in $path; do
    bup $REPOSITORY save $REMOTE_URL -n $branch $s_path
done

